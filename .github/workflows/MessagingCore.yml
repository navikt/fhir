# Name must match the IG's directory name.
name: MessagingCore

on:
  push:
    branches: [main]
    paths: [igs/MessagingCore/**]
  workflow_dispatch:

# The following jobs are equal for all IGs and can be moved to a common composite-action if 'uses'-support is added, see:
# https://github.com/actions/runner/blob/main/docs/adrs/1144-composite-actions.md
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ↩️ Checkout branch
        uses: actions/checkout@v2

      - name: 📥 Download IG Publisher
        uses: docker://hl7fhir/ig-publisher-base:latest
        with:
          args: curl -L https://github.com/HL7/fhir-ig-publisher/releases/latest/download/publisher.jar -o ./input-cache/publisher.jar --create-dirs

      - name: 📦 Run IG Publisher
        uses: docker://hl7fhir/ig-publisher-base:latest
        with:
          args: java -jar ./input-cache/publisher.jar publisher -ig igs/${{ github.workflow }}/ig.ini

      - name: 🚀 Deploy to GitHub-Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./igs/${{ github.workflow }}/output
          destination_dir: ./igs/${{ github.workflow }}
          exclude_assets: '**.zip,**.tgz,**.pack'
          commit_message: '${{ github.workflow }}: ${{ github.event.head_commit.message }}'

      - name: 🔖 Get Id and Version
        uses: CumulusDS/get-yaml-paths-action@v0.1.0
        id: sushi_config
        with:
          file: ./igs/${{ github.workflow }}/sushi-config.yaml
          id: id
          version: version

      - name: 📄 Get Changelog Entry
        uses: mindsers/changelog-reader-action@v2
        id: changelog
        with:
          path: ./igs/${{ github.workflow }}/input/pagecontent/CHANGELOG.md
          version: ${{ steps.sushi_config.outputs.version }}

      - name: 🏷️ Push release tag
        uses: actions-ecosystem/action-push-tag@v1
        with:
          tag: ${{ steps.sushi_config.outputs.id }}@${{ steps.sushi_config.outputs.version }}

      - name: 📮 Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.sushi_config.outputs.id }}@${{ steps.sushi_config.outputs.version }}
          body: ${{ steps.changelog.outputs.changes }}
          prerelease: ${{ steps.changelog.outputs.status == 'prereleased' }}
          draft: ${{ steps.changelog.outputs.status == 'unreleased' }}
          files: |
            ./igs/${{ github.workflow }}/output/package.tgz