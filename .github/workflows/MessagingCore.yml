# Workflow name must match the IG directory name.
name: MessagingCore

on:
  push:
    branches: [main]
    paths: [igs/MessagingCore/**]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:          
      - name: 🔎 Get URL of latest IG Publisher
        id: latest-publisher
        run: |
          echo "::set-output name=URL::$( \
            curl -SSL https://api.github.com/repos/HL7/fhir-ig-publisher/releases/latest \
            | jq .assets[0] | jq .browser_download_url -r \
          )"

      - name: 💾 Setup IG Publisher cache
        uses: actions/cache@v2
        id: publisher-cache
        with:
          path: ./input-cache
          key: ${{ runner.os }}-${{ steps.latest-publisher.outputs.URL }}

      - name: 📥 Download latest IG Publisher
        if: steps.publisher-cache.outputs.cache-hit != 'true'
        run: |
          echo Downloading: ${{ steps.latest-publisher.outputs.URL }}
          curl -L ${{ steps.latest-publisher.outputs.URL }} -o ./input-cache/publisher.jar --create-dirs

      - name: 📝 Checkout branch
        uses: actions/checkout@v2

      - name: 📦 Run the IG Publisher
        uses: docker://hl7fhir/ig-publisher-base:latest
        with:
          args: java -jar ./input-cache/publisher.jar publisher -ig igs/${{ github.workflow }}/ig.ini